---
title: "Homework 6"
author: "Anusorn Thanataveerat"
date: "November 15, 2018"
output: github_document
toc: true
toc_float: true
code_folding: hide
---

```{r setup, include=FALSE}
library(tidyverse)
library(janitor)
library(knitr)
library(broom)
library(lubridate)

knitr::opts_chunk$set(echo = TRUE,
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)
```

## Problem 1

``` {r Problem_1, message = FALSE}
homicide_dat <-
  read_csv('https://raw.githubusercontent.com/washingtonpost/data-homicides/master/homicide-data.csv') %>% 
  mutate(reported_date = ymd(reported_date), 
         city_state = paste(city, state, sep = ', '),
         victim_race = factor(ifelse(victim_race != 'White', 'non-white', 'white'),
        #Set white as reference group   
        levels = c('white', 'non-white')),
        victim_age = as.numeric(victim_age),
        resolved = ifelse(disposition == "Closed by arrest", 1, 0)) %>% 
        #fllter the following cities out
      filter(!(city_state %in% c('Dallas, TX', 'Phoenix, AZ', 'Kansas City, MO', 'Tulsa, AL')))
```

Look at the city of Baltimore data and fit the logistic regression

```{r baltimore}
baltimore_logistic <- homicide_dat %>% 
  filter(city_state == 'Baltimore, MD') %>% 
  glm(resolved ~ victim_age + victim_sex + victim_race,
      family = binomial(link = 'logit'), data = .) 

 baltimore_logistic %>% 
  broom::tidy() %>% 
  mutate(OR = exp(estimate)) %>%
  bind_cols(.,  exp(confint_tidy(baltimore_logistic))) %>% 
  select(term, OR, conf.low, conf.high) %>% 
  filter(term == 'victim_racenon-white') %>% 
  knitr::kable(digits = 3)
```

The odds ratios of solving homicides comparing non-white victims to white victims keeping all other variables fixed is 0.44 (0.31, 0.62).


```{r warning = FALSE}
#Function of fitting glm and produce OR with CI
glm_or_ci_function <- function(dat){
  logistic <- glm(resolved ~ victim_age + victim_sex + victim_race,
      family = binomial(link = 'logit'), data = dat) 

 logistic %>% 
  broom::tidy() %>% 
  mutate(OR = exp(estimate)) %>%
  bind_cols(.,  exp(confint_tidy(logistic))) %>% 
  select(term, OR, conf.low, conf.high) %>% 
  filter(term == 'victim_racenon-white')
}

 ORs_df <- homicide_dat %>% 
   select(victim_age, victim_race, victim_sex, resolved, city_state) %>% 
  nest(., victim_age:resolved) %>% 
   mutate(models = map(data, glm_or_ci_function)) 
 
 ORs_df %>% 
   select(-data) %>% 
   unnest() %>% 
   ggplot(aes(x = city_state, y = OR)) +
   geom_pointrange(aes(ymin = conf.low, ymax = conf.high)) +
   geom_hline(yintercept = 1, linetype = "dotdash", 
              color = "red", size = 0.6) +
   ylab('OR of resolved crime') + 
   xlab('') +
   ggtitle('non-white vs white') +
   theme(axis.text.x = element_text(color = "blue", size = 8, angle = 90))

```

Comment: main estimates: mostly below 1. those with statistically sig are xxx . some noteworthy city where the trend is reversed abc

## Problem 2
```{r data_cleaning}
dat <- read_csv('data/birthweight.csv') %>% 
  mutate_at(c('babysex', 'frace', 'malform',
              'mrace'), funs(factor(.))) %>% 
  mutate(smoke = as.factor(ifelse(smoken > 0, 1, 0)))
  
#check for missing data
skimr::skim(dat)
```

first create smoking binary variable from `smoken` since the data is zero heavy and wouldn't make much sense to try to establish a linear relationship between that and the outcome. The data doesn't appear to contain missing information.

Propose a regression model for birthweight: Lasso since 1) helps with the variable selection.

```{r lasso}
library(glmnet)


```

